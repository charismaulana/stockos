<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>StockOS</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#0a0a0f;--surface:#13131c;--surface2:#1c1c2a;--border:#2a2a3d;
  --accent:#00e5ff;--accent2:#ff4d6d;--in-color:#b8ff57;--out-color:#ff4d6d;
  --text:#f0f0f8;--muted:#6b6b8a;
  --font:'Syne',sans-serif;--mono:'DM Mono',monospace;
  --radius:14px;--radius-sm:8px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-tap-highlight-color:transparent;}
body{min-height:100dvh;display:flex;flex-direction:column;overflow-x:hidden;}

/* ‚îÄ‚îÄ Setup ‚îÄ‚îÄ */
#setupScreen{position:fixed;inset:0;z-index:500;background:var(--bg);display:none;
  flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;text-align:center;overflow-y:auto;}
#setupScreen.show{display:flex;}
.setup-emoji{font-size:3.5rem;margin-bottom:16px;}
#setupScreen h1{font-size:2rem;font-weight:800;margin-bottom:8px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
#setupScreen p{color:var(--muted);font-size:.85rem;margin-bottom:28px;line-height:1.6;max-width:360px;}
.setup-card{width:100%;max-width:400px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
.setup-field{margin-bottom:14px;}
.setup-field label{display:block;font-size:.7rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;text-align:left;}
.setup-field input,.setup-field select{width:100%;padding:12px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font);font-size:.88rem;font-weight:600;outline:none;transition:border-color .2s;-webkit-appearance:none;appearance:none;}
.setup-field input:focus,.setup-field select:focus{border-color:var(--accent);}
.setup-field select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b6b8a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px;}
.btn-setup{width:100%;padding:14px;border-radius:var(--radius-sm);background:var(--accent);border:none;color:#0a0a0f;font-family:var(--font);font-size:.95rem;font-weight:800;cursor:pointer;margin-top:4px;}

/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
#loadingOverlay{position:fixed;inset:0;z-index:400;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.loading-logo{font-size:2.2rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
#loadingOverlay p{color:var(--muted);font-size:.83rem;}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header{position:sticky;top:0;z-index:100;background:rgba(10,10,15,.92);backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);padding:0 16px;display:flex;align-items:center;justify-content:space-between;height:60px;}
.logo{font-size:1.1rem;font-weight:800;letter-spacing:-.02em;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.logo span{font-weight:400;opacity:.5;}
.user-badge{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:4px 12px 4px 6px;cursor:pointer;font-size:.78rem;font-weight:600;}
.avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:800;color:#000;}

/* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
.nav-bar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;flex-shrink:0;}
.nav-bar::-webkit-scrollbar{display:none;}
.nav-btn{flex:1;min-width:75px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:10px 6px;border:none;background:transparent;color:var(--muted);font-family:var(--font);font-size:.6rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;cursor:pointer;transition:color .2s;position:relative;}
.nav-btn svg{width:20px;height:20px;}
.nav-btn.active{color:var(--accent);}
.nav-btn.active::after{content:"";position:absolute;bottom:0;left:20%;right:20%;height:2px;background:var(--accent);border-radius:2px 2px 0 0;}

/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
main{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:16px;}
.page{display:none;animation:fadeUp .3s ease;}
.page.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ Shared ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin:12px;overflow:hidden;}
.card-body{padding:16px;}
.form-group{margin-bottom:14px;}
label{display:block;font-size:.72rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
input[type="text"],input[type="number"],select,textarea{width:100%;padding:12px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:var(--font);font-size:.9rem;font-weight:600;transition:border-color .2s;-webkit-appearance:none;appearance:none;outline:none;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);background:#151522;}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b6b8a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px;}
.section-label{padding:0 12px 8px;font-size:.72rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);}
.divider{height:1px;background:var(--border);margin:4px 0 14px;}

/* Buttons */
.btn-primary{width:100%;padding:16px;border-radius:var(--radius-sm);background:var(--accent);border:none;color:#0a0a0f;font-family:var(--font);font-size:.95rem;font-weight:800;cursor:pointer;transition:opacity .15s,transform .1s;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-primary:active{opacity:.85;transform:scale(.98);}
.btn-primary:disabled{opacity:.4;pointer-events:none;}
.btn-primary.out-mode{background:var(--out-color);}
.btn-secondary{width:100%;padding:12px;border-radius:var(--radius-sm);background:transparent;border:1.5px solid var(--border);color:var(--text);font-family:var(--font);font-size:.85rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:border-color .2s;}
.btn-secondary:active{border-color:var(--accent);}
.btn-scan{width:100%;padding:12px;border-radius:var(--radius-sm);background:rgba(0,229,255,.08);border:1.5px dashed rgba(0,229,255,.4);color:var(--accent);font-family:var(--font);font-size:.85rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;margin-bottom:10px;}
.btn-scan:active{background:rgba(0,229,255,.15);}
.btn-scan svg{width:18px;height:18px;}

/* Type toggle */
.type-toggle{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.type-btn{padding:14px;border:2px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--muted);font-family:var(--font);font-size:.85rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;}
.type-btn.active-in{border-color:var(--in-color);color:var(--in-color);background:rgba(184,255,87,.06);}
.type-btn.active-out{border-color:var(--out-color);color:var(--out-color);background:rgba(255,77,109,.06);}

/* ‚îÄ‚îÄ CART ‚îÄ‚îÄ */
.cart-wrap{margin:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
.cart-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.cart-title{font-size:.82rem;font-weight:800;letter-spacing:.04em;text-transform:uppercase;}
.cart-badge{background:var(--accent);color:#000;border-radius:20px;padding:2px 10px;font-size:.72rem;font-weight:800;font-family:var(--mono);}
.cart-badge.out{background:var(--out-color);}
.cart-empty{padding:20px;text-align:center;color:var(--muted);font-size:.82rem;}
.cart-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);}
.cart-item:last-child{border-bottom:none;}
.cart-item-img{width:40px;height:40px;border-radius:8px;object-fit:cover;background:var(--surface2);flex-shrink:0;border:1px solid var(--border);}
.cart-item-img-placeholder{width:40px;height:40px;border-radius:8px;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.cart-item-info{flex:1;min-width:0;}
.cart-item-name{font-size:.85rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cart-item-id{font-family:var(--mono);font-size:.65rem;color:var(--muted);}
.cart-item-qty-wrap{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.qty-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:1rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;}
.qty-btn:active{background:var(--border);}
.cart-qty-display{font-family:var(--mono);font-size:.9rem;font-weight:700;min-width:24px;text-align:center;}
.cart-remove{width:28px;height:28px;border-radius:6px;border:none;background:rgba(255,77,109,.1);color:var(--out-color);font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-left:4px;}

/* Item lookup preview */
.item-preview{display:none;align-items:center;gap:10px;background:rgba(0,229,255,.06);border:1px solid rgba(0,229,255,.2);border-radius:var(--radius-sm);padding:10px 14px;margin-top:8px;}
.item-preview.show{display:flex;}
.item-preview-img{width:32px;height:32px;border-radius:6px;object-fit:cover;flex-shrink:0;}
.item-preview-img-placeholder{width:32px;height:32px;border-radius:6px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
.item-preview-name{font-size:.88rem;font-weight:700;}
.item-preview-stock{font-family:var(--mono);font-size:.75rem;color:var(--accent);margin-left:auto;white-space:nowrap;}
.stock-low{color:var(--out-color)!important;}

/* Add to cart button */
.btn-add-cart{width:100%;padding:13px;border-radius:var(--radius-sm);background:rgba(0,229,255,.1);border:1.5px solid rgba(0,229,255,.3);color:var(--accent);font-family:var(--font);font-size:.88rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;margin-top:10px;}
.btn-add-cart:active{background:rgba(0,229,255,.2);}
.btn-add-cart.out{background:rgba(255,77,109,.1);border-color:rgba(255,77,109,.3);color:var(--out-color);}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);z-index:1000;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 20px;font-size:.85rem;font-weight:600;max-width:calc(100% - 32px);opacity:0;transition:opacity .25s,transform .25s;pointer-events:none;text-align:center;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
#toast.success{border-color:var(--in-color);color:var(--in-color);}
#toast.error{border-color:var(--out-color);color:var(--out-color);}
#toast.warn{border-color:#ffd166;color:#ffd166;}

/* ‚îÄ‚îÄ Stats & QA ‚îÄ‚îÄ */
.stats-grid{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
.stat-label{font-size:.65rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.stat-value{font-family:var(--mono);font-size:2rem;font-weight:700;line-height:1;}
.stat-card.alert .stat-value{color:var(--out-color);}
.stat-card.accent .stat-value{color:var(--accent);}
.stat-card.green .stat-value{color:var(--in-color);}
.quick-actions{padding:0 12px 12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.qa-btn{padding:16px 12px;border-radius:var(--radius);border:none;cursor:pointer;font-family:var(--font);font-weight:700;font-size:.82rem;display:flex;flex-direction:column;align-items:flex-start;gap:8px;transition:transform .1s;}
.qa-btn:active{transform:scale(.97);}
.qa-btn.in{background:rgba(184,255,87,.1);color:var(--in-color);border:1.5px solid rgba(184,255,87,.2);}
.qa-btn.out{background:rgba(255,77,109,.1);color:var(--out-color);border:1.5px solid rgba(255,77,109,.2);}
.qa-btn svg{width:22px;height:22px;}

/* ‚îÄ‚îÄ Stock ‚îÄ‚îÄ */
.filter-bar{padding:12px 12px 0;display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;}
.filter-bar::-webkit-scrollbar{display:none;}
.filter-chip{padding:6px 14px;border-radius:20px;border:1.5px solid var(--border);background:transparent;color:var(--muted);font-family:var(--font);font-size:.72rem;font-weight:700;white-space:nowrap;cursor:pointer;transition:all .2s;}
.filter-chip.active{border-color:var(--accent);color:var(--accent);background:rgba(0,229,255,.06);}
.stock-grid{padding:12px;display:grid;gap:10px;}
.stock-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:12px;position:relative;overflow:hidden;}
.stock-card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:3px;}
.stock-card.ok::before{background:var(--in-color);}
.stock-card.low::before{background:var(--out-color);}
.stock-item-img{width:44px;height:44px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);}
.stock-item-img-placeholder{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;}
.stock-card.ok .stock-item-img-placeholder{background:rgba(184,255,87,.1);}
.stock-card.low .stock-item-img-placeholder{background:rgba(255,77,109,.1);}
.stock-info{flex:1;min-width:0;}
.stock-name{font-size:.9rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.stock-id{font-family:var(--mono);font-size:.68rem;color:var(--muted);margin-top:2px;}
.stock-qty-wrap{text-align:right;flex-shrink:0;}
.stock-qty{font-family:var(--mono);font-size:1.5rem;font-weight:700;line-height:1;}
.stock-card.ok .stock-qty{color:var(--in-color);}
.stock-card.low .stock-qty{color:var(--out-color);}
.stock-unit{font-size:.68rem;color:var(--muted);}
.stock-badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:.6rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;margin-top:4px;}
.badge-ok{background:rgba(184,255,87,.12);color:var(--in-color);}
.badge-low{background:rgba(255,77,109,.12);color:var(--out-color);}

/* ‚îÄ‚îÄ History ‚îÄ‚îÄ */
.tx-list{padding:12px;display:flex;flex-direction:column;gap:8px;}
.tx-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;}
.tx-header{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.tx-type-badge{padding:3px 10px;border-radius:20px;font-size:.7rem;font-weight:800;flex-shrink:0;}
.tx-type-badge.IN{background:rgba(184,255,87,.12);color:var(--in-color);}
.tx-type-badge.OUT{background:rgba(255,77,109,.12);color:var(--out-color);}
.tx-meta-main{font-size:.75rem;color:var(--muted);flex:1;}
.tx-timestamp{font-size:.68rem;color:var(--muted);margin-left:auto;white-space:nowrap;}
.tx-items-list{display:flex;flex-direction:column;gap:4px;}
.tx-row{display:flex;align-items:center;gap:8px;padding:4px 0;border-top:1px solid rgba(255,255,255,.04);}
.tx-row:first-child{border-top:none;}
.tx-row-img{width:24px;height:24px;border-radius:4px;object-fit:cover;flex-shrink:0;}
.tx-row-img-placeholder{width:24px;height:24px;border-radius:4px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:.65rem;flex-shrink:0;}
.tx-row-name{flex:1;font-size:.8rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tx-row-qty{font-family:var(--mono);font-size:.8rem;font-weight:700;flex-shrink:0;}
.tx-row-qty.IN{color:var(--in-color);}
.tx-row-qty.OUT{color:var(--out-color);}

/* ‚îÄ‚îÄ Scanner Modal ‚îÄ‚îÄ */
#scannerModal{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.96);display:none;flex-direction:column;align-items:center;justify-content:flex-start;}
#scannerModal.show{display:flex;}
.scanner-header{width:100%;display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:rgba(10,10,15,.8);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);}
.scanner-title{font-size:1rem;font-weight:800;}
.scanner-close{width:36px;height:36px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.scanner-body{flex:1;width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:16px;}
#qr-reader{width:100%;max-width:340px;border-radius:var(--radius);overflow:hidden;border:2px solid var(--accent);box-shadow:0 0 30px rgba(0,229,255,.2);}
#qr-reader video{border-radius:12px;}
#qr-reader img{display:none!important;}
#qr-reader__dashboard{display:none!important;}
.scanner-hint{color:var(--muted);font-size:.82rem;text-align:center;line-height:1.5;}
.scanner-hint strong{color:var(--accent);display:block;font-size:.95rem;margin-bottom:4px;}
.scanner-frame{position:relative;width:100%;max-width:340px;}
.scanner-corners{position:absolute;inset:0;pointer-events:none;z-index:10;}
.scanner-corners::before,.scanner-corners::after{content:"";position:absolute;width:28px;height:28px;border-color:var(--accent);border-style:solid;}
.scanner-corners::before{top:8px;left:8px;border-width:3px 0 0 3px;border-radius:4px 0 0 0;}
.scanner-corners::after{bottom:8px;right:8px;border-width:0 3px 3px 0;border-radius:0 0 4px 0;}
.scanner-extra-corners{position:absolute;inset:0;pointer-events:none;z-index:10;}
.scanner-extra-corners::before,.scanner-extra-corners::after{content:"";position:absolute;width:28px;height:28px;border-color:var(--accent);border-style:solid;}
.scanner-extra-corners::before{top:8px;right:8px;border-width:3px 3px 0 0;border-radius:0 4px 0 0;}
.scanner-extra-corners::after{bottom:8px;left:8px;border-width:0 0 3px 3px;border-radius:0 0 0 4px;}
.scan-line{position:absolute;left:12px;right:12px;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);z-index:11;animation:scanline 2s ease-in-out infinite;}
@keyframes scanline{0%,100%{top:15%;opacity:.8;}50%{top:85%;opacity:1;}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,229,255,.2);}50%{box-shadow:0 0 0 14px rgba(0,229,255,0);}}

/* spinner */
.spinner{width:18px;height:18px;border:2px solid rgba(10,10,15,.3);border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}
.empty{text-align:center;padding:40px 20px;color:var(--muted);}
.empty p{font-size:.85rem;}
</style>
</head>
<body>

<!-- Setup Screen -->
<div id="setupScreen">
  <div class="setup-emoji">üì¶</div>
  <h1>StockOS</h1>
  <p>Lengkapi data dirimu sekali saja. Tersimpan otomatis di HP ini.</p>
  <div class="setup-card">
    <div class="setup-field">
      <label>Nama Lengkap</label>
      <input type="text" id="setupName" placeholder="e.g. Budi Santoso" autocomplete="name"/>
    </div>
    <div class="setup-field">
      <label>Departemen</label>
      <select id="setupDept">
        <option value="">-- Pilih Departemen --</option>
        <option>GS</option><option>ICT</option><option>SCM</option><option>HSSE</option>
        <option>PO</option><option>RAM</option><option>WS</option><option>FM</option>
        <option>LMF&amp;Relation</option><option>PE</option><option>Plan&amp;Eval</option>
      </select>
    </div>
    <div class="setup-field">
      <label>Lokasi</label>
      <select id="setupLocation">
        <option value="">-- Pilih Lokasi --</option>
        <option>Ramba</option><option>Bentayan</option><option>Mangunjaya</option><option>Keluang</option>
      </select>
    </div>
    <button class="btn-setup" onclick="saveSetup()">Mulai Sekarang ‚Üí</button>
  </div>
</div>

<!-- Loading -->
<div id="loadingOverlay">
  <div class="loading-logo">StockOS</div>
  <div class="spinner" style="color:var(--accent);width:28px;height:28px;border-width:3px;"></div>
  <p id="loadingMsg">Memuat data‚Ä¶</p>
</div>

<!-- App -->
<div id="app" style="display:none;flex-direction:column;min-height:100dvh;">
  <header>
    <div class="logo">STOCK<span>OS</span></div>
    <div class="user-badge" onclick="changeUser()">
      <div class="avatar" id="avatarInitial">?</div>
      <span id="headerName">‚Äì</span>
    </div>
  </header>
  <nav class="nav-bar">
    <button class="nav-btn active" onclick="showPage('home')" id="nav-home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Home
    </button>
    <button class="nav-btn" onclick="showPage('scan')" id="nav-scan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/><line x1="7" y1="12" x2="17" y2="12"/><line x1="12" y1="7" x2="12" y2="17"/></svg>Scan
    </button>
    <button class="nav-btn" onclick="showPage('stock')" id="nav-stock">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Stock
    </button>
    <button class="nav-btn" onclick="showPage('history')" id="nav-history">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>History
    </button>
  </nav>
  <main>

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="stats-grid">
        <div class="stat-card accent"><div class="stat-label">Total Items</div><div class="stat-value" id="statTotal">‚Äì</div></div>
        <div class="stat-card alert"><div class="stat-label">Low Stock</div><div class="stat-value" id="statLow">‚Äì</div></div>
        <div class="stat-card green"><div class="stat-label">Today IN</div><div class="stat-value" id="statIn">‚Äì</div></div>
        <div class="stat-card"><div class="stat-label">Today OUT</div><div class="stat-value" id="statOut">‚Äì</div></div>
      </div>
      <div class="section-label">Quick Action</div>
      <div class="quick-actions">
        <button class="qa-btn in" onclick="goScan('IN')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Stock IN</button>
        <button class="qa-btn out" onclick="goScan('OUT')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>Stock OUT</button>
      </div>
      <div class="section-label">‚ö†Ô∏è Low Stock</div>
      <div id="lowStockList" style="padding:0 12px 12px;"><div class="empty"><p>Loading‚Ä¶</p></div></div>
    </div>

    <!-- SCAN (MULTI-ITEM CART) -->
    <div class="page" id="page-scan">

      <!-- Type toggle -->
      <div class="card">
        <div class="card-body" style="padding-bottom:12px;">
          <div class="form-group" style="margin-bottom:0;">
            <label>Tipe Transaksi</label>
            <div class="type-toggle">
              <button class="type-btn active-in" id="btnIN" onclick="setType('IN')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Masuk
              </button>
              <button class="type-btn" id="btnOUT" onclick="setType('OUT')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>Keluar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add item section -->
      <div class="card">
        <div class="card-body">
          <div class="form-group">
            <label>Tambah Barang</label>
            <button class="btn-scan" onclick="openScanner()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 7V5a2 2 0 012-2h2M17 3h2a2 2 0 012 2v2M21 17v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"/><rect x="7" y="7" width="3" height="3"/><rect x="14" y="7" width="3" height="3"/><rect x="7" y="14" width="3" height="3"/></svg>
              Buka Kamera & Scan Barcode
            </button>
            <input type="text" id="itemIdInput" placeholder="Atau ketik Item ID e.g. OFF-001"
              oninput="onItemIdChange()" autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"/>
            <!-- Item preview -->
            <div class="item-preview" id="itemPreview">
              <div class="item-preview-img-placeholder" id="previewImgWrap">üì¶</div>
              <div>
                <div class="item-preview-name" id="previewName"></div>
                <div style="font-size:.68rem;color:var(--muted)" id="previewCat"></div>
              </div>
              <div class="item-preview-stock" id="previewStock"></div>
            </div>
          </div>
          <div class="form-group">
            <label>Jumlah</label>
            <input type="number" id="qtyInput" placeholder="0" min="1" inputmode="numeric"/>
          </div>
          <button class="btn-add-cart" id="addCartBtn" onclick="addToCart()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Tambah ke Daftar
          </button>
        </div>
      </div>

      <!-- Cart -->
      <div class="cart-wrap">
        <div class="cart-header">
          <span class="cart-title">üõí Daftar Barang</span>
          <span class="cart-badge" id="cartBadge">0 item</span>
        </div>
        <div id="cartList"><div class="cart-empty">Belum ada barang. Tambahkan di atas.</div></div>
      </div>

      <!-- Requester Info + Submit -->
      <div class="card">
        <div class="card-body">
          <div class="divider" style="margin-top:0;"></div>
          <div style="font-size:.68rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;">Info Peminta</div>
          <div class="form-group">
            <label>Nama Peminta</label>
            <input type="text" id="requesterInput" placeholder="Nama yang meminta ATK"/>
          </div>
          <div class="form-group">
            <label>Departemen</label>
            <select id="deptInput">
              <option value="">-- Pilih Departemen --</option>
              <option>GS</option><option>ICT</option><option>SCM</option><option>HSSE</option>
              <option>PO</option><option>RAM</option><option>WS</option><option>FM</option>
              <option>LMF&amp;Relation</option><option>PE</option><option>Plan&amp;Eval</option>
            </select>
          </div>
          <div class="form-group">
            <label>Lokasi</label>
            <select id="locationInput">
              <option value="">-- Pilih Lokasi --</option>
              <option>Ramba</option><option>Bentayan</option><option>Mangunjaya</option><option>Keluang</option>
            </select>
          </div>
          <div class="form-group">
            <label>Catatan <span style="color:var(--muted);font-weight:400;text-transform:none;">(opsional)</span></label>
            <input type="text" id="notesInput" placeholder="e.g. Restock bulanan"/>
          </div>
          <button class="btn-primary" id="submitBtn" onclick="submitForm()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
            Submit Semua Barang
          </button>
        </div>
      </div>
    </div>

    <!-- STOCK -->
    <div class="page" id="page-stock">
      <div style="padding:12px 12px 0;display:flex;gap:8px;align-items:center;justify-content:space-between;">
        <input type="text" id="stockSearch" placeholder="Cari barang‚Ä¶" oninput="renderStock(currentFilter)" style="flex:1;font-size:.82rem;margin:0;padding:10px 14px;"/>
      </div>
      <div class="filter-bar">
        <button class="filter-chip active" onclick="filterStock('ALL',this)">Semua</button>
        <button class="filter-chip" onclick="filterStock('LOW',this)">‚ö†Ô∏è Low</button>
        <button class="filter-chip" onclick="filterStock('OK',this)">‚úÖ OK</button>
      </div>
      <div class="stock-grid" id="stockGrid"><div class="empty"><p>Loading‚Ä¶</p></div></div>
    </div>

    <!-- HISTORY -->
    <div class="page" id="page-history">
      <div class="card" style="margin:12px 12px 0;">
        <div class="card-body" style="padding:10px 12px;">
          <input type="text" id="historySearch" placeholder="Cari nama barang, karyawan, atau dept‚Ä¶" oninput="renderHistory()" style="margin:0;font-size:.82rem;"/>
        </div>
      </div>
      <div class="tx-list" id="txList"><div class="empty"><p>Loading‚Ä¶</p></div></div>
    </div>

  </main>
</div>

<!-- Camera Scanner Modal -->
<div id="scannerModal">
  <div class="scanner-header">
    <div class="scanner-title">üì∑ Scan Barcode</div>
    <button class="scanner-close" onclick="closeScanner()">‚úï</button>
  </div>
  <div class="scanner-body">
    <div class="scanner-frame">
      <div id="qr-reader"></div>
      <div class="scanner-corners"></div>
      <div class="scanner-extra-corners"></div>
      <div class="scan-line"></div>
    </div>
    <div class="scanner-hint">
      <strong>Arahkan kamera ke barcode</strong>
      QR Code, Code128, EAN, UPC, dan lainnya
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API_URL    = "https://script.google.com/macros/s/AKfycbzmtF64YgJcYg_YjA1iFDTvjnMzCx49SW_0fa1bpFYQz3ZQCO--pZfxCCI4wifM-gzb8A/exec";
let employeeName = localStorage.getItem("stockos_name") || "";
let employeeDept = localStorage.getItem("stockos_dept") || "";
let employeeLoc  = localStorage.getItem("stockos_loc")  || "";
let currentType  = "IN";
let currentFilter= "ALL";
let allStock     = [];
let allHistory   = [];
let itemCache    = {};   // { itemId: itemData }
let imageCache   = {};   // { itemId: imageUrl } loaded from Google Sheet (column F MASTER_ITEMS)
let lookupTimer  = null;
let cart         = [];   // [{ itemId, name, unit, qty, img }]

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = function() {
  if (!employeeName) {
    document.getElementById("loadingOverlay").style.display = "none";
    document.getElementById("setupScreen").classList.add("show");
    return;
  }
  initApp();
};

function initApp() {
  updateEmployeeDisplay();
  document.getElementById("app").style.display = "flex";
  if (employeeName) document.getElementById("requesterInput").value = employeeName;
  if (employeeDept) document.getElementById("deptInput").value      = employeeDept;
  if (employeeLoc)  document.getElementById("locationInput").value  = employeeLoc;
  loadAll();
}

// ‚îÄ‚îÄ Setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveSetup() {
  const name = document.getElementById("setupName").value.trim();
  const dept = document.getElementById("setupDept").value;
  const loc  = document.getElementById("setupLocation").value;
  if (!name) { showToast("Masukkan nama kamu","error"); return; }
  if (!dept) { showToast("Pilih departemen","error"); return; }
  if (!loc)  { showToast("Pilih lokasi","error"); return; }
  employeeName = name; employeeDept = dept; employeeLoc = loc;
  localStorage.setItem("stockos_name", name);
  localStorage.setItem("stockos_dept", dept);
  localStorage.setItem("stockos_loc",  loc);
  document.getElementById("setupScreen").classList.remove("show");
  initApp();
}
function changeUser() {
  localStorage.removeItem("stockos_name");
  localStorage.removeItem("stockos_dept");
  localStorage.removeItem("stockos_loc");
  employeeName=""; employeeDept=""; employeeLoc="";
  document.getElementById("setupName").value = "";
  document.getElementById("setupDept").value = "";
  document.getElementById("setupLocation").value = "";
  document.getElementById("setupScreen").classList.add("show");
}
function updateEmployeeDisplay() {
  document.getElementById("headerName").textContent    = (employeeName||"‚Äì").split(" ")[0] + (employeeDept?" ¬∑ "+employeeDept:"");
  document.getElementById("avatarInitial").textContent = (employeeName[0]||"?").toUpperCase();
}

// ‚îÄ‚îÄ JSONP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _cbIdx = 0;
function jsonp(params) {
  return new Promise((resolve, reject) => {
    const cb = "_cb" + (++_cbIdx);
    const t  = setTimeout(() => { cleanup(); reject(new Error("Timeout")); }, 15000);
    window[cb] = (data) => { clearTimeout(t); cleanup(); resolve(data); };
    function cleanup() { delete window[cb]; const s=document.getElementById("_s"+cb); if(s)s.remove(); }
    params.callback = cb;
    const qs = Object.entries(params).map(([k,v])=>encodeURIComponent(k)+"="+encodeURIComponent(v)).join("&");
    const s = document.createElement("script");
    s.id = "_s"+cb; s.src = API_URL+"?"+qs;
    s.onerror = () => { clearTimeout(t); cleanup(); reject(new Error("Gagal konek ke server")); };
    document.head.appendChild(s);
  });
}

// ‚îÄ‚îÄ Load all ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAll() {
  document.getElementById("loadingOverlay").style.display = "flex";
  try {
    const [stock, history] = await Promise.all([
      jsonp({ action:"stock" }),
      jsonp({ action:"history" })
    ]);
    allStock   = stock;
    allHistory = history;
    // Build imageCache from stock data (imageUrl comes from column F of MASTER_ITEMS)
    imageCache = {};
    stock.forEach(s => {
      if (s.imageUrl) imageCache[s.id.toUpperCase()] = s.imageUrl;
      itemCache[s.id.toUpperCase()] = { found:true, id:s.id, name:s.name, category:s.category, unit:s.unit, minStock:s.minStock, current:s.current, imageUrl:s.imageUrl||"" };
    });
    renderDashboard();
    renderStock("ALL");
    renderHistory();
    document.getElementById("loadingOverlay").style.display = "none";
  } catch(e) {
    document.getElementById("loadingMsg").textContent = "‚ùå " + e.message;
    document.getElementById("loadingMsg").style.color = "var(--out-color)";
    document.getElementById("loadingOverlay").innerHTML += `<button onclick="location.reload()" style="margin-top:12px;padding:10px 24px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font);font-weight:700;cursor:pointer;">Coba Lagi</button>`;
  }
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id) {
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
  document.getElementById("page-"+id).classList.add("active");
  document.getElementById("nav-"+id).classList.add("active");
}
function goScan(type) {
  showPage("scan"); setType(type);
  setTimeout(()=>document.getElementById("itemIdInput").focus(), 200);
}
function setType(t) {
  currentType = t;
  document.getElementById("btnIN").className  = "type-btn"+(t==="IN" ?" active-in":"");
  document.getElementById("btnOUT").className = "type-btn"+(t==="OUT"?" active-out":"");
  document.getElementById("submitBtn").className = "btn-primary"+(t==="OUT"?" out-mode":"");
  document.getElementById("addCartBtn").className = "btn-add-cart"+(t==="OUT"?" out":"");
  const badge = document.getElementById("cartBadge");
  badge.className = "cart-badge"+(t==="OUT"?" out":"");
}

// ‚îÄ‚îÄ Camera Scanner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let html5QrCode = null, scannerOpen = false;
function openScanner() {
  if (scannerOpen) return;
  document.getElementById("scannerModal").classList.add("show");
  scannerOpen = true;
  setTimeout(() => {
    html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start({ facingMode:"environment" }, { fps:10, qrbox:{width:240,height:180}, aspectRatio:1.0 },
      (code) => onBarcodeScanned(code),
      () => {}
    ).catch(err => { showToast("Kamera tidak bisa diakses: "+err,"error"); closeScanner(); });
  }, 300);
}
function closeScanner() {
  if (html5QrCode && scannerOpen) {
    html5QrCode.stop().catch(()=>{}).finally(()=>{ html5QrCode=null; scannerOpen=false; document.getElementById("scannerModal").classList.remove("show"); });
  } else { scannerOpen=false; document.getElementById("scannerModal").classList.remove("show"); }
}
function onBarcodeScanned(code) {
  if (navigator.vibrate) navigator.vibrate(100);
  closeScanner();
  document.getElementById("itemIdInput").value = code.trim().toUpperCase();
  showToast("‚úÖ Barcode: "+code, "success");
  onItemIdChange();
  setTimeout(()=>document.getElementById("qtyInput").focus(), 600);
}
document.addEventListener("keydown", e=>{ if(e.key==="Escape"&&scannerOpen) closeScanner(); });

// ‚îÄ‚îÄ Item lookup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onItemIdChange() {
  clearTimeout(lookupTimer);
  const id = document.getElementById("itemIdInput").value.trim();
  if (!id) { hidePreview(); return; }
  lookupTimer = setTimeout(()=>doLookup(id), 600);
}
async function doLookup(id) {
  const key = id.toUpperCase();
  if (itemCache[key]) { showPreview(itemCache[key]); return; }
  try {
    const res = await jsonp({ action:"lookup", id });
    if (res.found) { itemCache[res.id.toUpperCase()] = res; showPreview(res); }
    else hidePreview();
  } catch(e) { hidePreview(); }
}
function showPreview(item) {
  document.getElementById("previewName").textContent = item.name;
  document.getElementById("previewCat").textContent  = item.category+" ¬∑ "+item.unit;
  const el = document.getElementById("previewStock");
  el.textContent = "Stok: "+item.current+" "+item.unit;
  el.className   = "item-preview-stock"+(item.current<=item.minStock?" stock-low":"");
  const imgWrap = document.getElementById("previewImgWrap");
  imgWrap.innerHTML = getImgEl(item.id, 32, "6px");
  document.getElementById("itemPreview").classList.add("show");
}
function hidePreview() { document.getElementById("itemPreview").classList.remove("show"); }

// ‚îÄ‚îÄ CART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addToCart() {
  const itemId = document.getElementById("itemIdInput").value.trim().toUpperCase();
  const qty    = parseInt(document.getElementById("qtyInput").value);
  if (!itemId) { showToast("Scan atau masukkan Item ID dulu","error"); return; }
  if (!qty || qty<=0) { showToast("Masukkan jumlah yang valid","error"); return; }
  const item = itemCache[itemId];
  if (!item) { showToast("Item tidak ditemukan","error"); return; }

  // Check if already in cart ‚Üí update qty
  const existing = cart.find(c=>c.itemId===itemId);
  if (existing) {
    existing.qty += qty;
    showToast(`üì¶ ${item.name} diupdate: ${existing.qty} ${item.unit}`,"success");
  } else {
    cart.push({ itemId, name:item.name, unit:item.unit, qty, current:item.current, minStock:item.minStock });
    showToast(`‚úÖ ${item.name} ditambahkan`,"success");
  }

  // Reset add-item fields
  document.getElementById("itemIdInput").value = "";
  document.getElementById("qtyInput").value    = "";
  hidePreview();
  renderCart();
}

function removeFromCart(idx) {
  cart.splice(idx, 1);
  renderCart();
}

function changeCartQty(idx, delta) {
  cart[idx].qty = Math.max(1, cart[idx].qty + delta);
  renderCart();
}

function renderCart() {
  const list  = document.getElementById("cartList");
  const badge = document.getElementById("cartBadge");
  badge.textContent = cart.length + " item";

  if (!cart.length) {
    list.innerHTML = '<div class="cart-empty">Belum ada barang. Tambahkan di atas.</div>';
    return;
  }
  list.innerHTML = cart.map((c, i) => {
    return `<div class="cart-item">
      ${getImgEl(c.itemId, 40, "8px")}
      <div class="cart-item-info">
        <div class="cart-item-name">${c.name}</div>
        <div class="cart-item-id">${c.itemId} ¬∑ ${c.unit}</div>
      </div>
      <div class="cart-item-qty-wrap">
        <button class="qty-btn" onclick="changeCartQty(${i},-1)">‚àí</button>
        <span class="cart-qty-display">${c.qty}</span>
        <button class="qty-btn" onclick="changeCartQty(${i},+1)">+</button>
        <button class="cart-remove" onclick="removeFromCart(${i})">‚úï</button>
      </div>
    </div>`;
  }).join("");
}

// ‚îÄ‚îÄ Submit (multi-item) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitForm() {
  if (!cart.length) { showToast("Tambahkan minimal 1 barang ke daftar","error"); return; }
  const requester = document.getElementById("requesterInput").value.trim();
  const dept      = document.getElementById("deptInput").value;
  const location  = document.getElementById("locationInput").value;
  const notes     = document.getElementById("notesInput").value.trim();
  if (!requester) { showToast("Masukkan nama peminta","error"); return; }
  if (!dept)      { showToast("Pilih departemen","error"); return; }
  if (!location)  { showToast("Pilih lokasi","error"); return; }

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Menyimpan '+cart.length+' barang‚Ä¶';

  let successCount = 0, failCount = 0;
  for (const item of cart) {
    try {
      const res = await jsonp({
        action:"submit", itemId:item.itemId, type:currentType,
        qty:item.qty, employee:employeeName,
        requester, dept, location,
        notes: notes || (dept+" ¬∑ "+location)
      });
      if (res.ok) {
        successCount++;
        if (itemCache[item.itemId]) itemCache[item.itemId].current = res.newBalance;
      } else {
        failCount++;
        showToast(`‚ùå ${item.name}: ${res.msg}`, "error");
        await new Promise(r=>setTimeout(r,1500));
      }
    } catch(e) {
      failCount++;
    }
  }

  btn.disabled = false;
  btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg> Submit Semua Barang';

  if (successCount > 0) {
    showToast(`‚úÖ ${successCount} barang berhasil disimpan${failCount>0?" ("+failCount+" gagal)":""}`, failCount>0?"warn":"success");
    cart = [];
    renderCart();
    document.getElementById("notesInput").value = "";
    loadAll();
  }
}

// ‚îÄ‚îÄ Image helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Foto diambil dari kolom F (Image URL) di sheet MASTER_ITEMS
// Upload foto: buka Google Sheet ‚Üí MASTER_ITEMS ‚Üí kolom "Image URL"
// Paste URL gambar (Google Drive, Imgur, dll) ‚Üí refresh web app
function getImgEl(itemId, size, rounded) {
  const url = imageCache[(itemId||"").toUpperCase()];
  const r   = rounded || "8px";
  if (url) return `<img src="${url}" style="width:${size}px;height:${size}px;border-radius:${r};object-fit:cover;flex-shrink:0;" onerror="this.style.display='none'"/>`;
  return `<div style="width:${size}px;height:${size}px;border-radius:${r};background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:${Math.round(size*0.45)}px;flex-shrink:0;">${getItemEmoji("")}</div>`;
}

// ‚îÄ‚îÄ Render Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  const low = allStock.filter(d=>d.status==="LOW");
  document.getElementById("statTotal").textContent = allStock.length;
  document.getElementById("statLow").textContent   = low.length;
  const todayStr = new Date().toLocaleDateString("en-GB");
  const inT  = allHistory.filter(t=>t.timestamp.startsWith(todayStr)&&t.type==="IN").length;
  const outT = allHistory.filter(t=>t.timestamp.startsWith(todayStr)&&t.type==="OUT").length;
  document.getElementById("statIn").textContent  = inT;
  document.getElementById("statOut").textContent = outT;
  const c = document.getElementById("lowStockList");
  if (!low.length) { c.innerHTML='<div class="empty"><p>Semua stok aman üéâ</p></div>'; return; }
    c.innerHTML = low.map(item => {
      return `<div class="stock-card low" style="margin-bottom:8px;">
        ${getImgEl(item.id, 40, "10px")}
        <div class="stock-info"><div class="stock-name">${item.name}</div><div class="stock-id">${item.id}</div><span class="stock-badge badge-low">‚ö†Ô∏è Low</span></div>
        <div class="stock-qty-wrap"><div class="stock-qty">${item.current}</div><div class="stock-unit">${item.unit}</div></div>
      </div>`;
    }).join("");
}

// ‚îÄ‚îÄ Render Stock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterStock(f, el) {
  currentFilter = f;
  document.querySelectorAll(".filter-chip").forEach(c=>c.classList.remove("active"));
  el.classList.add("active");
  renderStock(f);
}
function renderStock(filter) {
  const grid = document.getElementById("stockGrid");
  const q    = (document.getElementById("stockSearch")||{}).value||"";
  let items  = allStock;
  if (filter==="LOW") items=items.filter(i=>i.status==="LOW");
  if (filter==="OK")  items=items.filter(i=>i.status==="OK");
  if (q) items=items.filter(i=>i.name.toLowerCase().includes(q.toLowerCase())||i.id.toLowerCase().includes(q.toLowerCase()));
  if (!items.length) { grid.innerHTML='<div class="empty"><p>Tidak ada item</p></div>'; return; }

  grid.innerHTML = items.map(item => {
    const isLow = item.status==="LOW";
    return `<div class="stock-card ${isLow?"low":"ok"}">
      ${getImgEl(item.id, 44, "10px")}
      <div class="stock-info">
        <div class="stock-name">${item.name}</div>
        <div class="stock-id">${item.id} ¬∑ ${item.category}</div>
        <span class="stock-badge ${isLow?"badge-low":"badge-ok"}">${isLow?"‚ö†Ô∏è Low":"‚úÖ OK"}</span>
      </div>
      <div class="stock-qty-wrap">
        <div class="stock-qty">${item.current}</div>
        <div class="stock-unit">${item.unit}</div>
        <div style="font-size:.6rem;color:var(--muted);margin-top:2px;">min:${item.minStock}</div>
      </div>
    </div>`;
  }).join("");
}

// ‚îÄ‚îÄ Render History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistory() {
  const q    = document.getElementById("historySearch").value.toLowerCase();
  const list = document.getElementById("txList");

  // Group transactions by batch (same employee+timestamp within 30s) or show individually
  let items = allHistory;
  if (q) items = items.filter(t =>
    t.itemName.toLowerCase().includes(q) ||
    (t.employee||"").toLowerCase().includes(q) ||
    (t.requester||"").toLowerCase().includes(q) ||
    (t.dept||"").toLowerCase().includes(q)
  );

  if (!items.length) { list.innerHTML='<div class="empty"><p>Tidak ada transaksi</p></div>'; return; }

  list.innerHTML = items.map(t => {
    return `<div class="tx-item">
      <div class="tx-header">
        <span class="tx-type-badge ${t.type}">${t.type}</span>
        <span class="tx-meta-main">${t.requester||t.employee} ¬∑ ${t.dept||""} ${t.location?"¬∑ "+t.location:""}</span>
        <span class="tx-timestamp">${t.timestamp}</span>
      </div>
      <div class="tx-items-list">
        <div class="tx-row">
          ${getImgEl(t.itemId, 24, "4px")}
          <span class="tx-row-name">${t.itemName}</span>
          <span class="tx-row-qty ${t.type}">${t.type==="IN"?"+":"‚àí"}${t.qty}</span>
          <span style="font-family:var(--mono);font-size:.65rem;color:var(--muted);margin-left:4px;">‚Üí${t.balance}</span>
        </div>
      </div>
    </div>`;
  }).join("");
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getItemEmoji(cat) {
  const m={"Stationery":"‚úèÔ∏è","Paper":"üìÑ","Ink":"üñäÔ∏è","Electronics":"üíª","Cleaning":"üßπ"};
  return m[cat]||"üì¶";
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type) {
  const el = document.getElementById("toast");
  el.textContent = msg; el.className = "show "+(type||"");
  clearTimeout(el._t); el._t = setTimeout(()=>el.className="", 3500);
}
</script>
</body>
</html>
